<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Draw on a canvas and mix elementary colors">
    <link rel="icon" href="icon.webp" type="image/webp">
    
    <title>Canvas</title>

    <style>
        :root {
            --canvas-clr: rgb(52, 52, 56);
            --cell-size: clamp(12px, min(3.25vw, 3.25vh), 40px); /* I put a limit to 40px
            because, after a certain size of the canvas, the border of the cells 
            (that is actually a box shadow) is no more clearly distinguishable. */
        }

        body {
            background-color: var(--canvas-clr);
            height: 100vh;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        #canvas {
            background-color: var(--canvas-clr);
            margin: calc(3 * var(--cell-size)); /* I put this margin
            because I want to give the user enough space to leave a marker on a side. */
        }

        .row {
            display: flex;
        }

        .cell {
            width: var(--cell-size);
            aspect-ratio: 1;
            box-shadow: inset 0 0 1px white;
        }

        #palette {
            display: flex;
            gap: 1rem;
        }

        .marker-container {
            width: calc(3 * var(--cell-size));
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgb(223, 223, 223);
        }

        .marker-container-hover {
            box-shadow: inset 0 0 5px black;
        }

        .marker {
            cursor: move;
            width: calc(2 * var(--cell-size));
            aspect-ratio: 1;
            z-index: 1;
            box-shadow: 0 0 2px black;
            position: absolute;
        }

        .marker-container:nth-child(3) .marker,
        .marker-container:nth-child(4) .marker {
            box-shadow: 0 0 2px white;
        }

        #r {
            background-color: rgb(255, 0, 0);
        }
        #g {
            background-color: rgb(0, 255, 0);
        }
        #b {
            background-color: rgb(0, 0, 255);
        }
        #u {
            background-color: var(--canvas-clr);
        }

        .r-- {
            background-color: rgb(255, 0, 0);
        }
        .-g- {
            background-color: rgb(0, 255, 0);
        }
        .--b {
            background-color: rgb(0, 0, 255);
        }
        .rg- {
            background-color: rgb(255, 255, 0);
        }
        .r-b {
            background-color: rgb(255, 0, 255);
        }
        .-gb {
            background-color: rgb(0, 255, 255);
        }
        .rgb {
            background-color: rgb(255, 255, 255);
        }

        /* vertical screen */
        @media (max-aspect-ratio: 1/1) {
            body {
                flex-direction: column;
            }

            #palette {
                flex-direction: row;
            }
        }

        /* horizontal screen */
        @media (min-aspect-ratio: 1/1) {
            body {
                flex-direction: row;
            }

            #palette {
                flex-direction: column;
            }
        }
    </style>
    <!-- <script src="./index.js" defer></script> -->
</head>
<body>
        <!-- directly inserting the canvas squares in the html file
        is way faster than dynamically adding them via JS later -->
        <div id="canvas">
            <div class="row">
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
            </div>
            <div class="row">
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
            </div>
            <div class="row">
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
            </div>
            <div class="row">
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
            </div>
            <div class="row">
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
            </div>
            <div class="row">
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
            </div>
            <div class="row">
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
            </div>
            <div class="row">
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
            </div>
            <div class="row">
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
            </div>
            <div class="row">
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
            </div>
            <div class="row">
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
            </div>
            <div class="row">
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
            </div>
            <div class="row">
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
            </div>
            <div class="row">
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
            </div>
            <div class="row">
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
            </div>
            <div class="row">
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
            </div>
            <div class="row">
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
            </div>
            <div class="row">
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
            </div>
            <div class="row">
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
            </div>
            <div class="row">
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
                <span class="cell"></span>
            </div>
        </div>

        <nav id="palette">
            <div class="marker-container">
                <div id="r" class="marker"></div>
            </div>
            <div class="marker-container">
                <div id="g" class="marker"></div>
            </div>
            <div class="marker-container">
                <div id="b" class="marker"></div>
            </div>
            <div class="marker-container">
                <div id="u" class="marker"></div>
            </div>
        </nav>

        <script>
            const canvas = document.querySelector('#canvas');

            /* cursor stands for both the mouse and the finger */
            let prev_cursor_x = 0;
            let prev_cursor_y = 0;

            let active_marker = null;
            let active_marker_container = null;
            let active_marker_container_rect = null;
            let grid_rect = canvas.getBoundingClientRect();

            window.addEventListener('resize', () => {
                grid_rect = canvas.getBoundingClientRect();
                /* I don't need to also re-calculate the active_marker_container_rect
                because, it is re-calculated every time the mousedown event fires on a marker. */
            });

            document.querySelectorAll('.marker').forEach(marker => {
                marker.addEventListener('mousedown', e => {
                    select_marker(e, marker)
                });
                marker.addEventListener('touchstart', e => {
                    select_marker(e, marker)
                }, { passive: true });
            });


            document.addEventListener('mousemove', e => {
                /* e.preventDefault(); */ // prevent scrolling
                move_marker(e);
            }, /* { passive: false } */);
            // https://developer.mozilla.org/en-US/docs/Web/API/EventTarget/addEventListener#using_passive_listeners
            document.addEventListener('touchmove', e => {
                e.preventDefault(); // prevent scrolling
                move_marker(e);
            }, { passive: false });


            document.addEventListener('mouseup', e => {
                lay_marker(e);
            });
            document.addEventListener('touchend', e => {
                lay_marker(e);
            });


            function select_marker(e, marker) 
            {
                if (e.type === 'mousedown' && e.button !== 0) {
                    return;
                }
                active_marker = marker;
                active_marker_container = marker.parentNode;
                active_marker_container_rect = active_marker_container.getBoundingClientRect();
                prev_cursor_x = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
                prev_cursor_y = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
                active_marker.style.zIndex = 2; /* To be above the other
                markers if hovered. */
            }

            function move_marker(e) 
            {
                if (!active_marker) return;

                const marker_left = Number(window.getComputedStyle(active_marker).left.split('px')[0]);
                const marker_top = Number(window.getComputedStyle(active_marker).top.split('px')[0]);
                
                const cursor_x = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
                const cursor_y = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;

                let left = 0;
                if (marker_left < 0) {
                    left = 0;
                } else if (document.body.offsetWidth - (marker_left + active_marker.offsetWidth) < 0) {
                    left = document.body.offsetWidth - active_marker.offsetWidth;
                } else {
                    left = marker_left + (cursor_x - prev_cursor_x);
                }
                
                let top = 0;
                if (marker_top < 0) {
                    top = 0;
                } else if (document.body.offsetHeight - (marker_top + active_marker.offsetHeight) < 0) {
                    top = document.body.offsetHeight - active_marker.offsetHeight;
                } else {
                    top = marker_top + (cursor_y - prev_cursor_y);
                }

                active_marker.style.left = `${left}px`;
                active_marker.style.top = `${top}px`;
                prev_cursor_x = cursor_x;
                prev_cursor_y = cursor_y;

                /* active_marker hovers its container */
                if (marker_in_boundaries(active_marker_container_rect, marker_top, marker_left)) {
                    active_marker_container.classList.add('marker-container-hover');
                } else {
                    active_marker_container.classList.remove('marker-container-hover');
                }

                /* active_marker touches the canvas */
                if (marker_in_boundaries(grid_rect, marker_top, marker_left)) 
                {
                    const cell_size = canvas.children[0].children[0].offsetWidth;
                    
                    const dist_from_left_border = marker_left - grid_rect.left;
                    const dist_from_top_border = marker_top - grid_rect.top;

                    const leftmost_cell = Math.floor(dist_from_left_border / cell_size); 
                    const rightmost_cell = Math.floor((dist_from_left_border + active_marker.offsetWidth) / cell_size);
                    const topmost_cell = Math.floor(dist_from_top_border / cell_size);
                    const bottommost_cell = Math.floor((dist_from_top_border + active_marker.offsetHeight) / cell_size);

                    const grid_size = canvas.children.length;
                    for (let i = topmost_cell; i <= bottommost_cell; i++) {
                        for (let j = leftmost_cell; j <= rightmost_cell; j++) 
                        {
                            if (i < 0 || j < 0 || i >= grid_size || j >= grid_size) continue;

                            if (active_marker.id === 'u') {
                                canvas.children[i].children[j].className = 'cell';
                            } else {
                                const child_class = canvas.children[i].children[j].className;
                                let color = child_class === 'cell' ? '---' : child_class.split(' ')[1];
                                if (!color.includes(active_marker.id)) {
                                    if (active_marker.id === 'r') color = 'r' + color[1] + color[2];
                                    else if (active_marker.id === 'g') color = color[0] + 'g' + color[2];
                                    else if (active_marker.id === 'b') color = color[0] + color[1] + 'b';
                                    else {
                                        console.error('unidentifiable active_marker.id:', active_marker.id);
                                        return;
                                    }
                                    canvas.children[i].children[j].className = `cell ${color}`;
                                }
                            }
                        }
                    }
                } // endif (active_marker on the canvas)
            }

            function lay_marker(e) 
            {
                if (e.type === 'mouseup' && e.button !== 0) return;
                if (!active_marker) return;

                const marker_left = Number(window.getComputedStyle(active_marker).left.split('px')[0]);
                const marker_top = Number(window.getComputedStyle(active_marker).top.split('px')[0]);
                
                if (marker_in_boundaries(active_marker_container_rect, marker_top, marker_left)) 
                {
                    active_marker_container.classList.remove('marker-container-hover');
                    active_marker.style.top = 'unset';
                    active_marker.style.left = 'unset';
                }

                active_marker.style.zIndex = 1;
                active_marker = null;
            }

            function marker_in_boundaries(container, marker_top, marker_left) {
                return (
                    /* x grows from top to bottom
                    y grows from left to right */
                    marker_top + active_marker.offsetHeight > container.top  &&
                    marker_top < container.bottom                            &&
                    marker_left + active_marker.offsetWidth > container.left &&
                    marker_left < container.right
                );
            }
        </script>
</body>
</html>
